<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Atelier mesures — Formation MSP</title>
  <meta name="description" content="Saisie des mesures par joueur, avec calcul des statistiques." />
  <meta name="theme-color" content="#60a5fa" />
  <style>
    :root{
      --bg:#0b1020; --fg:#e5e7eb; --muted:#a3b1c6;
      --accent:#60a5fa; --ok:#22c55e; --err:#f87171;
      --panel:#141a2f; --border:#263046;
      --ring:#94a3b8;
    }
    html,body{ margin:0; background:var(--bg); color:var(--fg); font:16px/1.55 system-ui, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap{ max-width:1100px; margin:0 auto; padding:1rem; }
    a{ color:inherit; }
    *{ box-sizing:border-box; }
    header{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; padding:.5rem 0 1rem; }
    .brand{ font-weight:800; letter-spacing:.2px; }
    .brand small{ display:block; color:var(--muted); font-weight:600; font-size:.9rem; margin-top:.15rem; }
    footer{ padding:1.5rem 0 1rem; color:var(--muted); font-size:.92rem; }
    main { margin-bottom:2rem; }

    /* Formulaire prénoms */
    .panel{ background:var(--panel); border:1px solid var(--border); border-radius:.75rem; padding:1rem; }
    .pn-label { margin-bottom: .3rem; }
    .prenoms-list{
      width:100%; max-width:340px; padding:.5rem; font-size:1rem; border-radius:.4rem; border:1px solid var(--border); background:var(--bg); color:var(--fg)
    }
    .btn{
      display:inline-block; font-weight:600; background:var(--accent); color:#fff; border:none; border-radius:.5rem;
      padding:.52rem 1.2rem; margin-top:.7rem; cursor:pointer; font-size:1.04rem; transition:filter .1s;
    }
    .btn:focus-visible{ outline:2px solid var(--accent); outline-offset:3px; }
    .btn:active{ filter:brightness(.92); }

    /* Tableau mesures */
    .mesures-table{
      width:100%; border-collapse:collapse; margin-top:2rem; margin-bottom:1rem;
      background:var(--panel); border:1px solid var(--border); border-radius:.75rem; overflow:hidden;
    }
    .mesures-table th, .mesures-table td{
      border:1px solid var(--border); padding:.5rem .7rem; text-align:center;
    }
    .mesures-table th{ background:rgba(96,165,250,.08); font-weight:600;}

    .mesures-table input[type="number"]{
      width:70px; font-size:1rem; border-radius:.3rem; border:1px solid var(--border);
      background:var(--bg); color:var(--fg); padding:.4rem .3rem; text-align:center;
    }
    .mesures-table input[type="number"]:focus{
      outline:2px solid var(--accent);
      border-color:var(--accent);
      background:var(--fg); color:var(--bg);
    }

    /* Colonnes de stats : style de base = comme les autres cellules */
    .mesures-table td[role="stats"]{
      background:var(--panel);
      color:var(--fg);
      font-weight:600;
    }
    .mesures-table td[role="stats"].empty{
      color:var(--muted);
      background:rgba(148,163,184,.07);
      font-weight:400;
      font-style:italic;
    }

    /* Meilleure moyenne (parmi tous les joueurs) – à droite uniquement */
    .best-average {
      background:rgba(34,197,94,.35) !important;
      color:#bbf7d0 !important;
      font-weight:700 !important;
    }

    /* Meilleur lancer (toutes mesures confondues) – à droite uniquement */
    .best-throw {
      background:rgba(34,197,94,.35) !important;
      color:#bbf7d0 !important;
      font-weight:700 !important;
    }

    @media (max-width:820px){
      .mesures-table th, .mesures-table td{ font-size:.98rem; padding:.45rem .4rem;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        Formation MSP
        <small>Atelier&nbsp;: Tableau de mesures par joueur</small>
      </div>
    </header>

    <main id="contenu">
      <section class="panel" aria-label="Entrée des prénoms">
        <form id="form-prenoms" autocomplete="off" onsubmit="return false;">
          <label for="prenoms" class="pn-label">Entrez jusqu'à <strong>10 prénoms</strong> (un prénom par ligne)&nbsp;:</label><br>
          <textarea autocomplete="off" autocapitalize="sentences" autocorrect="off" spellcheck="false" id="prenoms" name="prenoms"
            class="prenoms-list" rows="7" maxlength="150" placeholder="Exemple :&#10;Alice&#10;Benoît"></textarea>
          <br>
          <button type="submit" class="btn">Valider les prénoms</button>
        </form>
      </section>

      <section id="mesures-zone" style="display:none;">
        <table class="mesures-table">
          <thead>
            <tr>
              <th>Prénom</th>
              <th>Mesure&nbsp;1</th>
              <th>Mesure&nbsp;2</th>
              <th>Mesure&nbsp;3</th>
              <th>Mesure&nbsp;4</th>
              <th>Mesure&nbsp;5</th>
              <th>Moyenne</th>
              <th>Meilleur</th>
            </tr>
          </thead>
          <tbody id="table-mesures-body">
            <!-- Lignes générées dynamiquement -->
          </tbody>
        </table>
      </section>
    </main>

    <footer>
      © <time id="y"></time> — Atelier mesures MSP
    </footer>
  </div>

  <script>
    // Footer year
    document.getElementById('y').textContent = new Date().getFullYear();

    // Elements
    const formPrenoms = document.getElementById('form-prenoms');
    const inputPrenoms = document.getElementById('prenoms');
    const mesuresZone = document.getElementById('mesures-zone');
    const tableBody = document.getElementById('table-mesures-body');

    // Modèle des mesures (tableau d’objets)
    let joueurs = [];

    // Recalcule les meilleurs (moyenne + lancer) sur l’ensemble du tableau
    function recomputeGlobalHighlights() {
      let allAverages = [];
      let allThrows = [];

      joueurs.forEach((joueur, jdx) => {
        const vals = joueur.mesures.filter(x => typeof x === "number" && !isNaN(x));
        if (vals.length) {
          const avg = vals.reduce((a,b)=>a+b,0) / vals.length;
          allAverages.push({ jdx, avg });

          vals.forEach((v, idxMesure) => {
            allThrows.push({ jdx, idxMesure, value: v });
          });
        }
      });

      // Enlever anciennes classes sur les colonnes de droite
      document.querySelectorAll('.best-average').forEach(td => td.classList.remove('best-average'));
      document.querySelectorAll('.best-throw').forEach(td => td.classList.remove('best-throw'));

      // Meilleure moyenne = plus petite moyenne
      if (allAverages.length) {
        const bestAvg = Math.min(...allAverages.map(o => o.avg));
        const bestAvgPlayers = allAverages.filter(o => o.avg === bestAvg);
        bestAvgPlayers.forEach(o => {
          const tr = tableBody.children[o.jdx];
          const tdMoy = tr.children[6]; // colonne moyenne
          tdMoy.classList.add('best-average');
        });
      }

      // Meilleur lancer = plus petite valeur
      if (allThrows.length) {
        const bestVal = Math.min(...allThrows.map(o => o.value));
        const bestThrows = allThrows.filter(o => o.value === bestVal);
        bestThrows.forEach(o => {
          const tr = tableBody.children[o.jdx];
          // On n'ajoute la classe que sur la colonne "Meilleur" (8e colonne)
          const tdBest = tr.children[7];
          tdBest.classList.add('best-throw');
        });
      }
    }

    function renderMesuresTable() {
      tableBody.innerHTML = '';

      joueurs.forEach((joueur, jdx) => {
        let tr = document.createElement('tr');

        // Prénom
        let tdPrenom = document.createElement('td');
        tdPrenom.textContent = joueur.nom;
        tr.appendChild(tdPrenom);

        // Mesures
        for(let i=0; i<5; i++){
          let td = document.createElement('td');
          let input = document.createElement('input');
          input.type = 'number';
          input.inputMode = 'decimal';
          input.min = "0";        // uniquement valeurs positives
          input.max = "100000";
          input.step = 'any';
          input.placeholder = '-';
          input.value = joueur.mesures[i]!=null ? joueur.mesures[i] : '';
          input.size = 5;
          input.tabIndex = 0;
          input.setAttribute('aria-label', `Mesure ${i+1} pour ${joueur.nom}`);

          input.addEventListener('input', ev => {
            let raw = ev.target.value.replace(',','.');
            let val = parseFloat(raw);
            if (isNaN(val) || val < 0) {
              // valeur négative ou NaN -> on efface et garde null
              ev.target.value = '';
              joueur.mesures[i] = null;
            } else {
              joueur.mesures[i] = val;
            }
            refreshStatsLigne(jdx,tr);
            recomputeGlobalHighlights();
          });

          input.addEventListener('keydown', function(ev){
            if(ev.key === "Enter"){
              ev.preventDefault();
              let inputs = tr.querySelectorAll('input');
              if(i < 4) {
                inputs[i+1].focus();
                inputs[i+1].select();
              }
            }
          });

          td.appendChild(input);
          tr.appendChild(td);
        }

        // Statistiques : Moyenne & meilleur (min)
        let tdMoy = document.createElement('td');
        tdMoy.setAttribute('role','stats');
        let tdBest = document.createElement('td');
        tdBest.setAttribute('role','stats');

        let vals = joueur.mesures.filter(x=>typeof x==="number" && !isNaN(x));
        if(vals.length){
          let moy = vals.reduce((a,b)=>a+b,0) / vals.length;
          let best = Math.min(...vals); // meilleur = le plus petit
          tdMoy.textContent = moy.toFixed(2);
          tdBest.textContent = best;
        } else {
          tdMoy.textContent = "-"; tdBest.textContent = "-";
          tdMoy.className="empty";
          tdBest.className="empty";
        }
        tr.appendChild(tdMoy); tr.appendChild(tdBest);

        tableBody.appendChild(tr);
      });

      // Après rendu initial, calcul des meilleurs
      recomputeGlobalHighlights();
    }

    // Met à jour juste les stats de la ligne
    function refreshStatsLigne(jdx, tr){
      let joueur = joueurs[jdx];
      let vals = joueur.mesures.filter(x=>typeof x==="number" && !isNaN(x));
      let tdMoy = tr.children[6], tdBest = tr.children[7];
      if(vals.length){
        let moy = vals.reduce((a,b)=>a+b,0) / vals.length;
        let best = Math.min(...vals); // meilleur = le plus petit
        tdMoy.textContent = moy.toFixed(2);
        tdBest.textContent = best;
        tdMoy.classList.remove("empty");
        tdBest.classList.remove("empty");
      } else {
        tdMoy.textContent = "-"; tdBest.textContent = "-";
        tdMoy.className="empty";
        tdBest.className="empty";
      }
    }

    // Form validation > génération du tableau
    formPrenoms.addEventListener('submit', function(ev){
      ev.preventDefault();
      let noms = inputPrenoms.value.split('\n')
        .map(str=>str.trim())
        .filter(str=>str.length>0)
        .slice(0,10);
      if(noms.length===0){
        inputPrenoms.focus();
        return;
      }
      joueurs = noms.map(nom=>({nom, mesures:Array(5).fill(null)}));
      formPrenoms.parentNode.style.display='none';
      mesuresZone.style.display='';
      renderMesuresTable();
      setTimeout(()=>{
        let firstInput = mesuresZone.querySelector('input[type="number"]');
        if(firstInput) { firstInput.focus(); }
      },150);
    });

  </script>
</body>
</html>
